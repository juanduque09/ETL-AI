# ETL Facturas (Gemini + COP)

Este mini-proyecto procesa facturas en PDF usando Gemini (Google) para extraer campos en CSV, los convierte a DataFrame, transforma importes a COP y persiste en SQLite.

## Requisitos
- Python 3.10+ (probado con 3.11/3.12)
- Virtualenv o Conda
- Google API Key para Gemini
- Permisos de escritura en la carpeta del proyecto

## InstalaciÃ³n rÃ¡pida

### Con venv (recomendado)
```bash
# Clonar el repositorio
git clone https://github.com/juanduque09/ETL-AI.git
cd ETL-AI

# Crear y activar entorno virtual
python3 -m venv .venv
source .venv/bin/activate  # macOS/Linux
# .venv\Scripts\activate   # Windows

# Instalar dependencias
pip install -r requirements.txt
```

### Con conda (alternativo)
```bash
# Si prefieres usar conda
conda env create -f entorno.yml
conda activate gestor_gastos
```

## ConfiguraciÃ³n inicial

### 1. Configurar carpeta de facturas
```bash
# Crear carpeta con permisos correctos
mkdir -p facturas
chmod 755 facturas
```

### 2. Configurar variables de entorno
```bash
# Crear archivo .env (no se sube al repositorio por seguridad)
touch .env
```

Edita `.env` con tu configuraciÃ³n:
```bash
# ConfiguraciÃ³n principal
PROVIDER=gemini
MODEL_NAME=models/gemini-2.0-flash
GOOGLE_API_KEY=tu_api_key_aqui_desde_google_ai_studio

# ConversiÃ³n de monedas (tasas de referencia)
FALLBACK_RATE_USD_COP=4500
FALLBACK_RATE_EUR_COP=4900

# ConfiguraciÃ³n avanzada (opcional)
FALLBACK_MODEL=models/gemini-2.5-flash
MAX_OUTPUT_TOKENS=512
TEMPERATURE=0.0
BACKOFF_BASE=1.0
BACKOFF_MAX=30.0
BACKOFF_JITTER=0.5
LOG_LEVEL=INFO
LLM_METRICS_CSV=llm_usage.csv
LLM_RETRIES=5
```

### 3. Obtener Google API Key
1. Ve a [Google AI Studio](https://aistudio.google.com/)
2. Crea un nuevo proyecto o usa uno existente
3. Genera una API Key
4. CÃ³piala en tu archivo `.env`

## Uso del sistema

### 1. Probar conexiÃ³n con Gemini
```bash
python3 test_gemini.py
```

### 2. Crear facturas de prueba (opcional)
```bash
# Generar PDFs de ejemplo
python3 setup_demo.py

# Opciones disponibles:
# 1. Facturas fijas (siempre iguales)
# 2. Facturas aleatorias (diferentes cada vez)
# 3. Ambos tipos
```

### 3. Colocar tus facturas reales
```bash
# OpciÃ³n A: Directamente en ./facturas/
./facturas/mi_factura.pdf
./facturas/otra_factura.pdf

# OpciÃ³n B: En subcarpetas organizadas
./facturas/enero/factura1.pdf
./facturas/febrero/factura2.pdf
```

### 4. Procesar facturas
```bash
# Procesar todas las facturas y reemplazar tabla
python3 main.py --overwrite

# Procesar y anexar a datos existentes
python3 main.py

# Ver estructura de facturas disponibles
python3 debug_facturas.py
```

### 5. Inspeccionar resultados
```bash
# Consulta rÃ¡pida en consola
python3 -c "
import pandas as pd
from sqlalchemy import create_engine
engine = create_engine('sqlite:///facturas.db')
df = pd.read_sql('facturas', engine)
print('ğŸ“Š Total facturas procesadas:', len(df))
print('ğŸ’° Total en COP:', f'{df[\"importe\"].sum():,.0f}')
print('ğŸ“… Rango de fechas:', df['fecha_factura'].min(), 'a', df['fecha_factura'].max())
print('\nğŸ“‹ Resumen por proveedor:')
print(df.groupby('proveedor')['importe'].sum().sort_values(ascending=False).head())
print('\nğŸ“„ Muestra de datos:')
print(df.head())
"

# O usar cualquier herramienta SQLite para explorar facturas.db
```

## Estructura del proyecto
```
ETL-AI/
â”œâ”€â”€ ğŸ“ facturas/              # âš ï¸ PDFs (no se suben a Git por seguridad)
â”‚   â”œâ”€â”€ mi_factura.pdf
â”‚   â”œâ”€â”€ demo_*.pdf            # Facturas de ejemplo
â”‚   â””â”€â”€ random_*.pdf          # Facturas aleatorias
â”œâ”€â”€ ğŸ“„ .env                   # âš ï¸ Variables de entorno (no se sube a Git)
â”œâ”€â”€ ğŸ“„ main.py               # ğŸš€ Script principal del ETL
â”œâ”€â”€ ğŸ“„ funciones.py          # ğŸ”§ Funciones core (PDFâ†’CSVâ†’DB)
â”œâ”€â”€ ğŸ“„ prompt.py             # ğŸ¤– Prompt optimizado para Gemini
â”œâ”€â”€ ğŸ“„ test_gemini.py        # ğŸ§ª Tests y validaciÃ³n del sistema
â”œâ”€â”€ ğŸ“„ setup_demo.py         # ğŸ—ï¸ Generador de facturas de prueba
â”œâ”€â”€ ğŸ“„ debug_facturas.py     # ğŸ” Debug estructura de facturas
â”œâ”€â”€ ğŸ“„ requirements.txt      # ğŸ“¦ Dependencias Python
â”œâ”€â”€ ğŸ“„ entorno.yml           # ğŸ Alternativa con Conda
â”œâ”€â”€ ğŸ“„ facturas.db           # ğŸ’¾ Base de datos SQLite (generada)
â”œâ”€â”€ ğŸ“„ llm_usage.csv         # ğŸ“Š MÃ©tricas de uso de Gemini
â””â”€â”€ ğŸ“„ README.md             # ğŸ“– Esta documentaciÃ³n
```

## CaracterÃ­sticas principales

âœ… **Procesamiento automÃ¡tico**: Extrae texto de PDFs usando PyMuPDF  
âœ… **IA integrada**: Usa Gemini para estructurar datos de facturas  
âœ… **ConversiÃ³n de monedas**: USD/EUR â†’ COP automÃ¡ticamente  
âœ… **Reintentos inteligentes**: Backoff exponencial con modelo fallback  
âœ… **MÃ©tricas y logging**: AuditorÃ­a completa del uso de tokens  
âœ… **Flexible**: Soporta PDFs directos o en subcarpetas  
âœ… **Generador de pruebas**: Crea facturas de demo realistas  

## Seguridad y privacidad

ğŸ”’ **Datos protegidos**: Los PDFs y `.env` no se suben al repositorio  
ğŸ”’ **API Key segura**: ConfiguraciÃ³n local Ãºnicamente  
ğŸ”’ **Sin datos sensibles**: Solo metadatos estructurados en la DB  

## SoluciÃ³n de problemas

### âŒ Error de permisos
```bash
chmod 755 ./facturas
sudo chown -R $USER:$USER ./facturas  # si es necesario
```

### âŒ Error de API Key
- Verifica que `GOOGLE_API_KEY` estÃ© correcta en `.env`
- Confirma que la API estÃ© habilitada en Google AI Studio
- Prueba con: `python3 test_gemini.py`

### âŒ PDFs no detectados
```bash
python3 debug_facturas.py  # Ver quÃ© encuentra el sistema
ls -la ./facturas/         # Verificar archivos y permisos
```

### âŒ Error de conversiÃ³n CSV
- Revisa el archivo `llm_usage.csv` para ver errores de Gemini
- Aumenta `MAX_OUTPUT_TOKENS` en `.env` si las facturas son complejas
- Prueba con `LOG_LEVEL=DEBUG` para mÃ¡s detalles

## PrÃ³ximas mejoras

ğŸš€ **Interfaz web**: Streamlit para subir y procesar facturas  
ğŸš€ **OCR mejorado**: Para PDFs escaneados o de baja calidad  
ğŸš€ **CategorizaciÃ³n**: ClasificaciÃ³n automÃ¡tica de gastos  
ğŸš€ **Dashboard**: VisualizaciÃ³n de mÃ©tricas y tendencias  
ğŸš€ **API REST**: Endpoints para integraciÃ³n con otros sistemas  
ğŸš€ **Tests unitarios**: Cobertura completa de funcionalidades  

## ConfiguraciÃ³n de Git (para contribuir)
```bash
git init
git add .
git commit -m "feat: initial ETL implementation"
git branch -M main
git remote add origin https://github.com/juanduque09/ETL-AI.git
git push -u origin main
```

## Notas tÃ©cnicas

- **Reintentos**: Sistema robusto con backoff exponencial y jitter
- **Fallback**: Cambia automÃ¡ticamente de modelo si hay sobrecarga
- **MÃ©tricas**: Registro detallado en `llm_usage.csv` para auditorÃ­a
- **Formatos**: Soporta PDFs nativos (texto seleccionable)
- **Monedas**: ConversiÃ³n configurable USD/EUR â†’ COP
- **Logging**: Configurable desde INFO hasta DEBUG

---

